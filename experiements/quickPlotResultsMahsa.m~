clear

load('results/systemIDExperiment.mat')
numLevelsLen = length(sysID);
K = cell(numLevelsLen,1);
Gr = cell(numLevelsLen,1);
vafTot = cell(numLevelsLen,1);
vafIntrinsic = cell(numLevelsLen,1);
vafReflex = cell(numLevelsLen,1);
x = -2 :0.001:2;
x = nldat(x','domainIncr',0.001);
for i = 1 : numLevelsLen
    sysIDTemp = sysID{i};
    KTemp = zeros(size(sysID{i},1),size(sysIDTemp,2));
    vafTotTemp = zeros(size(sysID{i},1),size(sysIDTemp,2));
    vafIntrinsicTemp = zeros(size(sysID{i},1),size(sysIDTemp,2));
    vafReflexTemp = zeros(size(sysID{i},1),size(sysIDTemp,2));
    GrTemp = zeros(size(sysID{i},1),size(sysIDTemp,2));
    for j = 1 : size(sysIDTemp,1)%levels
        for k = 1 : size(sysIDTemp,2)%MC iteration
            systemTemp = sysIDTemp{j,k};
            intrinsicTemp = systemTemp{1};
            reflexTemp = systemTemp{2};
            reflexNLTemp = reflexTemp{1};
            y = nlsim(reflexNLTemp,x);
            if isnan(reflexNLTemp.polyCoef)
                slope = 0;
            else
                [~,slope] = slope_fitNoPlot(x.dataSet,y.dataSet,0);
            end
            GrTemp(j,k) = slope;
            vafsTemp = systemTemp{3};
            KTemp(j,k)= max(-0.01*sum(intrinsicTemp.dataSet),0);
            vafTotTemp(j,k)= vafsTemp(1);
            vafIntrinsicTemp(j,k)= vafsTemp(2);
            vafReflexTemp(j,k)= vafsTemp(3);
        end
    end
    K{i} = KTemp;
    Gr{i} = GrTemp;
    vafTot{i} = vafTotTemp;
    vafIntrinsic{i} = vafIntrinsicTemp;
    vafReflex{i} = vafReflexTemp;
end
%%
load results/experimentalTQVaryingData
voluntaryTorque = subject1.voluntaryTorque;
minTQ = prctile(voluntaryTorque,5);
maxTQ = prctile(voluntaryTorque,95);
numLevels = 3:7;
figure
for i = 1 : numLevelsLen
    levels = linspace(minTQ,maxTQ,numLevels(i));
    xAxis = (levels(1:end-1)+levels(2:end))/2;
    subplot(1,2,1)
    KTemp = K{i}';
    KTemp = max(KTemp,0);
    KTemp5 = prctile(KTemp,5);
    KTemp95 = prctile(KTemp,95);
    KTempMean = mean(KTemp) + i;
    plot(xAxis,KTempMean,'--')
    hold on
    errorbar(xAxis,KTempMean,KTempMean-KTemp5,KTemp95-KTempMean)
    subplot(1,2,2)
    GrTemp = max(GrTemp,0);
end