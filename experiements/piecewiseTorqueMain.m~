%preparePieceWiseTorqueData%Run if data is not saved
clear
clc
close all
filePath = '/Users/kian/Documents/publication/Jalaleddini-Kearney-Short-Segment/experiment/torque varying/';
load '/Users/kian/Documents/publication/Jalaleddini-Kearney-Short-Segment/experiment/torque varying/dataPieceWiseTorque.mat'
%%
samplingTime = 0.001;
data = dataPieceWiseTorque{4};
position = data(:,1);
torque = data(:,2);
command = data(:,8);
    
commandLevels = [0.2 0.4; -0.1 0.1; -0.4 -0.2];
%commandLevels = [0.35 0.45; 0.045 0.055; -0.01 0.01; -0.055 -0.045 ; -0.45 -0.35];
jumpIndex = cell(size(commandLevels,1),1);

for i = 1 : size(commandLevels,1)
    [jumpStart,jumpEnd] = findSegment(command,commandLevels(i,:));
    f = find( jumpEnd < jumpStart + 2000);
    jumpStart(f) = [];
    jumpEnd(f) = [];
    jumpIndex{i} = [jumpStart jumpEnd];
    plot(command)
    hold on
    plot(jumpStart,command(jumpStart),'o')
    plot(jumpEnd,command(jumpEnd),'go')
    pause
    close all
end
%%
%clc
warning off
order = 2;
segmentOnsetEnd = jumpIndex{3};
segmentLength = 5000;
segmentOnsetEnd(:,1) = segmentOnsetEnd(:,2) - 5000;

monteCarloIteration = 100;
segmentLengthMC = 500;

SDSS_System = cell(monteCarloIteration,3);
SS_SDSS_System = cell(monteCarloIteration,3);
for contractionConditionIndex = 1 : 3
    for segmentLengthMCIndex = 500:100:1000
        segmentNumMC = floor(60/segmentLengthMC*1000);
        for mcIndex = 1 : monteCarloIteration
            disp(['Iteration = ', num2str(mcIndex),' out of ',num2str(monteCarloIteration)])
            selectedSegment = randi([1 size(segmentOnsetEnd,1)],segmentNumMC,1);
            selectedSegmentOnset = randi([1 segmentLength-segmentLengthMC],segmentNumMC,1);
            onsetPointer = segmentOnsetEnd(selectedSegment,1) + selectedSegmentOnset;
            position = segdat(position,'onsetPointer',onsetPointer,...
            'segLength',ones(length(onsetPointer),1)*segmentLengthMC,'domainIncr',samplingTime...
            ,'comment','Position','chanNames','Joint angular position (rad)');
            torque = segdat(torque,'onsetPointer',onsetPointer,...
            'segLength',ones(length(onsetPointer),1)*segmentLengthMC,'domainIncr',samplingTime...
            ,'comment','Torque','chanNames','Joint torque (Nm)');
            z = cat(2,position,torque);
            sysID = pcas_short_segment_exp_new_intrinsic_irf1 (z,'maxordernle',8,'hanklesize',20,'delayinput',0.03,'orderselectmethod',order);
            SS_SDSS_System{mcIndex,1} = sysID{1};
            SS_SDSS_System{mcIndex,2} = sysID{2};
            SS_SDSS_System{mcIndex,3} = sysID{3};
            [intrinsic, reflex, tqI, tqR, tqT] = SDSS_stiffnessID (nldat(z),'orderselectmethod',order);
            tqMeasured = decimate(z(:,2),10);
            tqMeasured = tqMeasured.dataSet;
            tqI = tqI.dataSet;
            tqR = tqR.dataSet;
            tqT = tqT.dataSet;
            vi = vaf(tqMeasured,tqI);
            vR = vaf(tqMeasured,tqR);
            vT = vaf(tqMeasured,tqT);
            SDSS_System{mcIndex,1} = intrinsic;
            SDSS_System{mcIndex,2} = reflex;
            SDSS_System{mcIndex,3} = [vi;vR;vT];
        end
    end
end
